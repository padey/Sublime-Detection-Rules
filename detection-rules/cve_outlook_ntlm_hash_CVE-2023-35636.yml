name: "Outlook Vulnerability Leak NTLM Hashes / CVE-2023-35636"
description: |
  Varonis Threat Labs discovered a new Outlook vulnerability and three new ways to access NTLM v2 hashed passwords by exploiting Outlook, Windows Performance Analyzer (WPA), and Windows File Explorer. 
type: "rule"
severity: "high"
authors:
  - twitter: "affje0x65"
references:
  - https://www.varonis.com/blog/outlook-vulnerability-new-ways-to-leak-ntlm-hashes
source: |
  type.inbound
  and any(headers.hops,
            // "Content-Class" = "Sharing" — This tells Outlook that this email contains sharing content.
            any(.fields,
                  strings.contains(.name, "Content-Class")
                  and strings.contains(.value, "Sharing")
              ) and
              //"x-sharing-config-url" = \\(Attacker machine)\a.ics — The second line points the victim’s Outlook to the attacker’s machine.          
              any(.fields,
                  strings.contains(.name, "x-sharing-config-url")
                  and strings.ends_with(.value, "ics")
              )  
      )  and (
        (
          length(body.links) > 0
        )
    )
detection_methods:
  - "Header analysis"
